<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<link rel="stylesheet" type="text/css" href="static/extjs/resources/css/ext-all.css"/>
		<script type="text/javascript" src="static/extjs/adapter/ext/ext-base.js"></script>
		<script type="text/javascript" src="static/extjs/ext-all-debug-w-comments.js"></script>

		<script type="text/javascript" src="widget_fabric.js"></script>
		<script type="text/javascript" src="widget_loader.js"></script>
		<script type="text/javascript" src="widget_storage.js"></script>
		<script type="text/javascript" src="static/q/q.js"></script>
		<!--TODO - на будущее подключить библиотеку DeftJS для ExtJS4-->
		<!-- <script type="text/javascript" src="deft/js/deft-debug.js"></script>-->

		<script type="text/javascript">

			Ext.onReady(function() {

				var namespace = Ext,
					extLoader, simpleStorage, extFabric;

				//получаем экземпляр загрузчика статических файлов конфигов json
				extLoader = M3Rendering.WidgetLoader.create(namespace,
				 {simplify: false, baseUrl: 'static/json_configs/'});

				//получаем экземпляр хранилища конфигов
				simpleStorage = M3Rendering.WidgetStorage.create(namespace,
				 {useRegistry: true, simplify: true, standaloneConfigStorage: true});

				/*
				 * Тестирование фабрики без использования ExtJS хранилища
				 */
				 
				//получаем экземпляр фабрики оконных интерфейсов
				extFabric = M3Rendering.WidgetFabric.create(
					namespace, extLoader, simpleStorage,
					{useLoading: true, waitWarmUp: true});

				//у фабрики можно запустить режим предварительной загрузки
				//всех конфигураций, сохранении их в хранилище и регистрации классов в менеджере
				//все вызовы функции рисования виджетов будут ожидать окончания этого процесса
				extFabric.runWarmUp([
					{xtype: 'demoWindow'},
					{xtype: 'demoWindow2'}
				]);

				//создание окон после предварительной прогрузки конфигов
				//и регистрации классов в менеджере
				var promise1 = extFabric.createWidget({
					xtype: 'demoWindow',
					width: 200, x: 20,
					height: 100, y: 20
				});
				var promise2 = extFabric.createWidget({
					xtype: 'demoWindow2',
					width: 250, x: 20 + 200,
					height: 150, y: 20
				});

				//создание окно отложенно без режима warmUp
				//конфигурация будет подгруженна асинхронно
				var promise3 = extFabric.createWidget(
					{
						xtype: 'demoWindow3',
						width: 300, x: 20 + 200 + 250,
						height: 200, y: 20
					}
				);

				promise1.done(function() {
					console.log("window1 is rendered");
				});

				promise2.done(function() {
					console.log("window2 is rendered");
				});

				promise3.done(function() {
					console.log("window3 is rendered");
				});

				/**
					тестирование фабрики с использованием хранилища ExtJS
				 */
				extStorage = M3Rendering.WidgetStorage.create(namespace,
					{simplify: false, useRegistry: true, standaloneConfigStorage: true}
				);
				
				extStoragedFabric = M3Rendering.WidgetFabric.create(
					namespace, extLoader, extStorage,
					{useLoading: true, waitWarmUp: true}
				);

				extStoragedFabric.runWarmUp([]);

				var promise4 = extStoragedFabric.createWidget({
					xtype: 'demoWindow4',
					width: 350, x: 20 + 200 + 250 + 300,
					height: 250, y: 20
				});

				promise4.done(function() {
					console.log("window4 is rendered");
				});
			});

		</script>
	</head>
	<body>
		М3 Client Rendering
	</body>
</html>
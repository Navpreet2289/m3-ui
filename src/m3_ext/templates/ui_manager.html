{% load static %}
{% get_static_prefix as STATIC_URL %}

<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}/vendor/extjs/resources/css/ext-all.css"/>
        <script type="text/javascript" src="{{ STATIC_URL }}/vendor/extjs/adapter/ext/ext-base.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}/vendor/extjs/ext-all-debug-w-comments.js"></script>

        <script type="text/javascript" src="{{ STATIC_URL }}/m3/js/client-render/static/q/q.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}/m3/js/client-render/ui-manager/main.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}/m3/js/client-render/ui-manager/fabric.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}/m3/js/client-render/ui-manager/loader.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}/m3/js/client-render/ui-manager/storage.js"></script>

        <!--TODO - на будущее подключить библиотеку DeftJS для ExtJS4-->
        <!-- <script type="text/javascript" src="deft/js/deft-debug.js"></script>-->

        <script type="text/javascript">

            Ext.onReady(function() {

                var loader = {
                        require: function(key) {
                            var result = Q.defer();
                            Ext.Ajax.request({
                                method: 'POST',
                                params: {
                                    xtype: key
                                },
                                url: 'config',
                                success: function(response) {
                                    result.resolve(JSON.parse(response.responseText).config);
                                },
                                failure: function(err) {
                                    result.reject(new Error(err));
                                }
                            });
                            return result.promise;
                        }
                    },
                    storage = {
                        last: undefined,
                        get: function() {
                            return false
                        },
                        set: function(k, v) {
                            this.last = v;
                            return [{xtype:k}, v];
                        },
                        keyName: 'xtype',
                        getConfig: function() {
                            return this.last;
                        }
                    };

                //конфигурируем клиента для реализации настраиваемых
                //механизмов рендеринга окон/виджетов
                M3.Ext = new M3.UiMgr({
                    //настраиваем загрузчик статических файлов конфигов json
                    loader: loader,

                    storage: new M3.Ui.Storage(Ext, {})
                });

                M3.Ext.create({
                    xtype: 'demo-window'
                        // width: 250, x: 20 + 200,
                        // height: 150, y: 20
                }).done(function(win) {
                    console.log('loaded!');
                    win.show();
                });
            });
        </script>
    </head>
    <body>
        М3 Client Rendering
    </body>
</html>
